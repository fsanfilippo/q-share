<!doctype html>
<html>

<head>
  <title>q-share</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="font-awesome-4.7.0/css/font-awesome.min.css">
  <style type="text/css">
    #login,
    #loggedin {
      display: none;
    }

    .text-overflow {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      width: 500px;
    }

    #join-queue-input-group,
    #create-queue-input-group {
      width: 50%;
    }

    #create-queue-input,
    #join-queue-input {
      border-color: #58B955;

    }

    #join-queue-submit-primary,
    #create-queue-submit-primary {
      width: 100%;
      height: 128px;
      border: none;
      position: absolute;
      z-index: 2;
      background-color: white;
      border-radius: 0px 30px 30px 0px;

    }

    #join-queue-submit-primary:hover,
    #create-queue-submit-primary:hover {
      background-color: #28a745;
    }

    #jumbo-title {
      font-size: 13em;
      text-align: center;
      color: white;
      text-shadow: 4px 4px 8px #000000;
    }

    .title-container {
      margin-top: 7em;
      margin-bottom: 7em;
      margin-left: 14%;
      margin-right: 14%
    }

    #join-queue-input-group-primary,
    #create-queue-input-group-primary {
      margin-top: 1em;
      position: relative;


    }


    #join-queue-label,
    #create-queue-label {
      color: white;
      text-align: center;
      padding-left: 15px;
      font-size: 4em;
      text-shadow: 3px 3px 8px #000000;
    }

    #join-queue-input-primary,
    #create-queue-input-primary {
      height: 2em;
      font-size: 4em;
      border-radius: 30px 0px 0px 30px;
      padding-left: 29px;
      border: none;
      margin-right: -2px;
      flex: 0.75 1 auto;
    }

    #create-queue-btn-container,
    #join-queue-btn-container {
      flex: 0.25 1 auto;
      position: relative;

    }

    #label-input-container {
      margin-left: 17%;
      margin-right: 17%;
    }

    .form-group {
      margin-bottom: 5em;
    }

    .input-group {
      width: initial;
    }


    body {
      height: 100%;
      background-image: url('/verticalChiTown.jpg');
      background-color: black;
      background-size: cover;
      /* background-color: black; */
      background-repeat: no-repeat;
      background-attachment: fixed;
      background-position: center top;
    }

    html {
      min-height: 100%;
    }
  </style>
</head>

<body>

  <!--
    Login Page
  -->
  <div id="login">
    <div class="title-container">
      <h1 id="jumbo-title">q-share</h1>
    </div>
    <div class="form-group">
      <div id="label-input-container">
        <label for="join-queue-input-primary" id="join-queue-label">Join queue</label>
        <div id="join-queue-input-group-primary" class="input-group">
          <input id="join-queue-input-primary" type="text" class="form-control" placeholder="q name">
          <span class="input-group-btn" id="join-queue-btn-container">
            <button id="join-queue-submit-primary" class="btn btn-outline-success" type="button">
              <i class="fa fa-5x fa-users" aria-hidden="true"></i></button>
          </span>
        </div>
      </div>
    </div>

    <div class="form-group">
      <div id="label-input-container">
        <label for="create-queue-input-primary" id="join-queue-label">Create queue</label>
        <div id="create-queue-input-group-primary" class="input-group">
          <input id="create-queue-input-primary" type="text" class="form-control" placeholder="q name">
          <span class="input-group-btn" id="create-queue-btn-container">
            <button id="create-queue-submit-primary" class="btn btn-outline-success"
              onclick="loggedIn?createQueue():window.location.replace('/login')">
              <i class="fa fa-5x fa-grav" aria-hidden="true"></i></button>
          </span>
        </div>
      </div>
    </div>
  </div>




  <div id="loggedin">
    <div id="user-profile">
    </div>
    <div id="oauth">
    </div>
    <button class="btn btn-default" id="obtain-new-token">Obtain new token using the refresh token</button>
    <div class="container">
      <div class="input-group">
        <input id="search" type="text" class="form-control" placeholder="Search Song">
        <span class="input-group-btn">
          <button id="clear-search-btn" class="btn btn-default" type="button"><i class="fa fa-times"></i></button>
        </span>
        <span class="input-group-btn">
          <button id="search-btn" class="btn btn-default" type="button"><i class="fa fa-search"></i></button>
        </span>
      </div>
      <div id="search-results">
      </div>
      <div id="queue-display">
      </div>
    </div>
    <button class="btn btn-default" id="play-pause-song"><i id="play-pause-icon" class="fa fa-med fa-play-circle"
        aria-hidden="true"></i></button>
    <button class="btn btn-default" id="next-song"><i id="next-song-icon"
        class="fa fa-med fa-step-forward"></i></button>
    <div id="join-queue-input-group" class="input-group">
      <input id="join-queue-input" type="text" class="form-control" placeholder="Join a Queue">
      <span class="input-group-btn">
        <button id="join-queue-submit" class="btn btn-outline-success" type="button">
          <i class="fa fa-med fa-users" aria-hidden="true"></i></button>
      </span>
    </div>
    <div id="create-queue-input-group" class="input-group">
      <input id="create-queue-input" type="text" class="form-control" placeholder="Create a Queue">
      <span class="input-group-btn">
        <button id="create-queue-submit" class="btn btn-outline-success" type="button">
          <i class="fa fa-med fa-grav" aria-hidden="true"></i></button>
      </span>
    </div>
    <div id="device-list">
    </div>

  </div>
  </div>

  <script id="user-profile-template" type="text/x-handlebars-template">
    <h1>Logged in as {{display_name}}</h1>
    <div class="media">
      <div class="pull-left">
        <img class="media-object" width="150" src="{{images.0.url}}" />
      </div>
      <div class="media-body">
        <dl class="dl-horizontal">
          <dt>Display name</dt>
          <dd class="clearfix">{{display_name}}</dd>
          <dt>Id</dt>
          <dd>{{id}}</dd>
          <dt>Email</dt>
          <dd>{{email}}</dd>
          <dt>Spotify URI</dt>
          <dd><a href="{{external_urls.spotify}}">{{external_urls.spotify}}</a></dd>
          <dt>Link</dt>
          <dd><a href="{{href}}">{{href}}</a></dd>
          <dt>Profile Image</dt>
          <dd class="clearfix"><a href="{{images.0.url}}">{{images.0.url}}</a></dd>
          <dt>Country</dt>
          <dd>{{country}}</dd>
        </dl>
      </div>
    </div>
  </script>

  <script id="device-list-template" type="text/x-handlebars-template">
    <h3>Available Devices</h3>
    <ol>
      {{#each devices}}
      <li>{{this.name}}</li>
      {{/each}}
    </ol>
  </script>

  <script id="search-results-template" type="text/x-handlebars-template">
    <div class="container">
      <ul class="list-group">
        {{#each items}}
        <li class="list-group-item clearfix">
          <div class="container">
            <div class="row">
              <div class="col-sm-10">
                {{this.name}}
                <p>
                  <small class="text-muted">
                      {{#each this.artists}}
                      <span>{{this.name}}</span>
                      {{/each}}
                  </small>
                </p>
              </div>
              <div class="col-sm-2">
                <span class="pull-right">
                  <button class="btn btn-xs btn-default" onclick="addSongToQueue('{{@index}}')">
                    <i class="fa fa-plus"></i>
                  </button>
                </span>
              </div>
            </div>
          </div>
        </li>
        {{/each}}
      </ul>
    </div>
  </script>

  <script id="queue-display-template" type="text/x-handlebars-template">
    <h2>Play Queue</h2>
    <div class="container">
        <table class="table table-dark">
            <thead>
              <tr>
                <th scope="col">#</th>
                <th scope="col">Title</th>
                <th scope="col">Artist</th>
                <th scope="col">Time</th>
              </tr>
            </thead>
            <tbody>
              {{#each items}}
              <tr>
                {{#if @first}}
                  <td><i class="fa fa-volume-up"></i></td>
                {{else}}
                  <td scope="row">{{@index}} </td>
                {{/if}}
                <td>{{this.name}}</td>
                <td>{{this.artists.0.name}}</td>
                <td>{{this.duration_string}}</td>
              </tr>
              {{/each}}
            </tbody>
          </table>
    </div>
  </script>

  <script id="oauth-template" type="text/x-handlebars-template">
    <h2>oAuth info</h2>
    <dl class="dl-horizontal">
      <dt>Access token</dt>
      <dd class="text-overflow">{{access_token}}</dd>
      <dt>Refresh token</dt>
      <dd class="text-overflow">{{refresh_token}}</dd>
    </dl>
  </script>

  <script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/2.0.0-alpha.1/handlebars.min.js"></script>
  <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
  <script>
    var params = getHashParams();
    var devices;
    var queue = new Array();
    var qTimer; //timer that says when to play the next song
    var playState = "EMPTY";
    var playPauseIcon = document.getElementById('play-pause-icon');
    var searchResults;
    window.WebSocket = window.WebSocket || window.MozWebSocket;
    var connection = new WebSocket('ws://127.0.0.1:1337');
    var qOwned = false;
    var queueKey;
    var loggedIn = false;


    //Handlebar template variables
    var userProfileSource, userProfileTemplate, userProfilePlaceholder;
    var oauthSource, oauthTemplate, oauthPlaceholder;
    var deviceListSource, deviceListTemplate, deviceListPlaceholder;
    var searchResultsSource, searchResultsTemplate, searchResultsPlaceholder;
    var queueDisplaySource, queueDisplayTemplate, queueDisplayPlaceholder;
    var access_token, refresh_token, error;

    /**
     * Anything that needs to load after the page loads
     **/
    (function () {

      /**
       * Handlebar templates
       **/
      userProfileSource = document.getElementById('user-profile-template').innerHTML,
        userProfileTemplate = Handlebars.compile(userProfileSource),
        userProfilePlaceholder = document.getElementById('user-profile');

      oauthSource = document.getElementById('oauth-template').innerHTML,
        oauthTemplate = Handlebars.compile(oauthSource),
        oauthPlaceholder = document.getElementById('oauth');

      deviceListSource = document.getElementById('device-list-template').innerHTML,
        deviceListTemplate = Handlebars.compile(deviceListSource),
        deviceListPlaceholder = document.getElementById('device-list');

      searchResultsSource = document.getElementById('search-results-template').innerHTML,
        searchResultsTemplate = Handlebars.compile(searchResultsSource),
        searchResultsPlaceholder = document.getElementById('search-results');

      queueDisplaySource = document.getElementById('queue-display-template').innerHTML,
        queueDisplayTemplate = Handlebars.compile(queueDisplaySource),
        queueDisplayPlaceholder = document.getElementById('queue-display');


      /**
       * Get the access token and refresh token from the URL
       **/
      access_token = params.access_token,
        refresh_token = params.refresh_token,
        qid = params.qid,
        error = params.error;

      authenticateUser();

      /**
       * End Authentication Section
       **/

      /**
       * Attach click event listeners
       **/
      document.getElementById('obtain-new-token').addEventListener('click', obtainNewToken, false);
      document.getElementById('play-pause-song').addEventListener('click', resumeAndPause, false);
      document.getElementById('next-song').addEventListener('click', playNext, false);
      document.getElementById('search-btn').addEventListener('click', search, false);
      document.getElementById('clear-search-btn').addEventListener('click', clearSearch, false);
      document.getElementById('join-queue-submit').addEventListener('click', joinQueue, false);

      updateQueueDisplay();




    })();

    connection.onopen = function () {
      // connection is opened and ready to use
    };

    connection.onerror = function (error) {
      // an error occurred when sending/receiving data
    };

    connection.onmessage = function (message) {
      // try to decode json (I assume that each message
      // from server is json)
      var response;
      try {
        response = JSON.parse(message.data);
        console.log(response);

      } catch (e) {
        console.log('This doesn\'t look like a valid JSON: ',
          message.data);
        return;
      }
      switch (response.event) {
        case ("update"): {
          console.log("update recieved for queue: " + response.data.selectedQueue);
          let songs = response.data.songs
          if (!songs) break;
          if (!Array.isArray(songs)) break;

          if (queue.length !== 0) {
            var lastFirstSong = queue[0];
            console.log("last song uri: " + lastFirstSong.uri + " q uri: " + songs[0] || songs[0].uri)
          }
          queue = songs;

          updateQueueDisplay();
          if (qOwned) {
            //Queue previously empty. Start playing
            if (playState === 'EMPTY' && queue.length > 0) {
              playState = 'PLAYING';
              playSong();
            }
            //Queue updpates and it's empty. Stop playing
            else if (playState === 'PLAYING' && queue.length === 0) {
              resumeAndPause();
              playState = 'EMPTY';
            }
            //First song still be playing?
            else if (queue.length !== 0 && lastFirstSong && lastFirstSong.uri !== queue[0].uri) {
              console.log("new song from update!");
              playSong();
            }

          }

          break;
        }
        case ("stale-queue"): {
          alert("The selected Queue has expired");
          qOwned = false;
          queueKey = null;
          break;
        }

      }


      // handle incoming message
    };

    /**
       * Authenticate the User
       **/

    function authenticateUser() {
      if (error) {
        alert('There was an error during the authentication');
      } else {
        if (access_token) {
          // render oauth info
          let credentials = {
            access_token: access_token,
            refresh_token: refresh_token
          };

          oauthPlaceholder.innerHTML = oauthTemplate(credentials);

          $.ajax({
            url: 'https://api.spotify.com/v1/me',
            headers: {
              'Authorization': 'Bearer ' + access_token
            },
            error: function (response) {
              console.log(response);
              obtainNewToken();
            },
            success: function (response) {
              userProfilePlaceholder.innerHTML = userProfileTemplate(response);

              getDeviceList();
              loggedIn = true;
              $('#login').show();
              $('#loggedin').hide();

            }
          });
        } else {
          // render initial screen
          $('#login').show();
          $('#loggedin').hide();
        }
      }
    }

    function obtainNewToken() {
      $.ajax({
        url: '/refresh_token',
        data: {
          'refresh_token': refresh_token
        },
        error: function (error) {
          conosle.log(error);
        }
      }).done(function (data) {
        access_token = data.access_token;
        oauthPlaceholder.innerHTML = oauthTemplate({
          access_token: access_token,
          refresh_token: refresh_token
        });
        getDeviceList();
        authenticateUser();
      });
    }

    function getDeviceList() {
      $.ajax({
        url: 'https://api.spotify.com/v1/me/player/devices',
        headers: {
          'Authorization': 'Bearer ' + access_token
        },
        success: function (response) {
          devices = response.devices;
          deviceListPlaceholder.innerHTML = deviceListTemplate(response);
        }
      });

    }


    /**
     * Obtains parameters from the hash of the URL
     * @return Object
     */
    function getHashParams() {
      var hashParams = {};
      var e, r = /([^&;=]+)=?([^&;]*)/g,
        q = window.location.hash.substring(1);
      while (e = r.exec(q)) {
        hashParams[e[1]] = decodeURIComponent(e[2]);
      }
      return hashParams;
    }
    function addQIDtoURL(qid) {
      var hash = window.location.hash.substring(1);
      hash += "&qid=" + qid;
      window.location.hash = hash;
    }
    /**
     * Plays the next song in the queue and sets the timer for when to play the next song
     **/
    function playNext() {
      queue.shift();
      if (qOwned) {
        if (playState === 'EMPTY' || queue.length === 0) {
          playState = 'EMPTY'
        }
        else if (playState === 'PAUSED' || playState == 'PLAYING' && queue.length > 0) {
          playSong();
        }
        else if (playState === 'PLAYING' && queue.length === 0) {
          resumeAndPause();
          playState = 'EMPTY';
        }
      }
      broadcastUpdatedQueue();
    }

    function playSong() {
      if (queue.length == 0) { console.log("Queue is empty"); return; }
      playPauseIcon.className = 'fa fa-pause-circle fa-med'
      $.ajax({
        type: 'PUT',
        url: 'https://api.spotify.com/v1/me/player/play?device_id=' + devices[0].id,
        headers: {
          'Authorization': 'Bearer ' + access_token
        },
        data: JSON.stringify({
          "uris": [queue[0].uri]
        })

      }).done(function (data) {
        //nothing returned
      });

      if (qTimer) { qTimer.clear(); }
      console.log("Length of current song: " + queue[0].duration_ms);
      qTimer = new Timer(playNext, queue[0].duration_ms);

    }

    function resumeAndPause() {
      if (playState == "EMPTY") {
        alert("No song to resume. Add songs to the queue to play");
        return;
      }

      if (playState == 'PLAYING') {
        playState = 'PAUSED';
        qTimer.pause();
        $.ajax({
          type: 'PUT',
          url: 'https://api.spotify.com/v1/me/player/pause?device_id=' + devices[0].id,
          headers: {
            'Authorization': 'Bearer ' + access_token
          }
        }).done(function (data) {
          //nothing returned
        });
        playPauseIcon.className = 'fa fa-play-circle fa-med'
      }
      else if (playState == 'PAUSED') {
        playState = 'PLAYING';
        qTimer.resume();
        $.ajax({
          type: 'PUT',
          url: 'https://api.spotify.com/v1/me/player/play?device_id=' + devices[0].id,
          headers: {
            'Authorization': 'Bearer ' + access_token
          }
        }).done(function (data) {
          //nothing returned
        });
        playPauseIcon.className = 'fa fa-pause-circle fa-med'

      }

    }

    function formatTime(song) {
      let duration = song.duration_ms;
      let mins = Math.floor(duration / 1000 / 60);
      let secs = Math.floor((duration - mins * 1000 * 60) / 1000);
      secs = ("00" + secs).substr(-2, 2);
      song.duration_string = mins + ":" + secs;
    }

    function search() {
      var query = document.getElementById('search').value;
      $.ajax({
        type: 'GET',
        url: 'https://api.spotify.com/v1/search?type=track&limit=6&q=' + query,
        headers: {
          'Authorization': 'Bearer ' + access_token
        }
      }).done(function (data) {
        console.log(data.tracks);
        searchResultsPlaceholder.innerHTML = searchResultsTemplate(data.tracks);
        searchResults = data.tracks.items;
      });
    }

    function clearSearch() {
      document.getElementById('search').value = '';
      searchResults = [];
      searchResultsPlaceholder.innerHTML = searchResultsTemplate([]);

    }

    function Timer(callback, delay) {
      var timerId, start, remaining = delay;

      this.pause = function () {
        window.clearTimeout(timerId);
        remaining -= new Date() - start;
      };

      this.resume = function () {
        start = new Date();
        window.clearTimeout(timerId);
        timerId = window.setTimeout(callback, remaining);
      };

      this.clear = function () {
        window.clearTimeout(timerId);
      }

      this.resume();
    }

    function updateQueueDisplay() {
      console.log(queue);
      queueDisplayPlaceholder.innerHTML = queueDisplayTemplate({ items: queue });
    }

    function createQueue() {
      let selectedQueue = document.getElementById('create-queue-input-primary').value;
      console.log("created : " + selectedQueue);
      if (!selectedQueue) return;
      queueKey = selectedQueue;
      qOwned = true;
      connection.send(
        JSON.stringify({ event: 'create-queue', data: { queueKey: queueKey } })
      );
      addQIDtoURL(selectedQueue);

    }
    function addSongToQueue(songIndex) {

      formatTime(searchResults[songIndex]);
      if (!queueKey) {
        alert("Please subscribe to or create a queue");
      }
      songInfo = searchResults[songIndex];
      connection.send(
        JSON.stringify({ event: 'add-to-queue', data: { queueKey: queueKey, songData: songInfo } })
      );
    }
    function joinQueue() {
      let selectedQueue = document.getElementById('join-queue-input-primary').value;
      console.log("joined : " + selectedQueue);
      if (!selectedQueue) return;
      queueKey = selectedQueue;
      connection.send(
        JSON.stringify({ event: 'subscribe-to-queue', data: { queueKey: queueKey } })
      );
    }
    function broadcastUpdatedQueue() {
      if (!queueKey) return;
      console.log(queue);
      connection.send(
        JSON.stringify({ event: 'update-queue', data: { queueKey: queueKey, newQueue: queue } })
      );

    }

  </script>
</body>

</html>